// Connection status utility for LAN sync

// Detect environment and set appropriate API URL
// If loaded from localhost:5000 (Electron production), use /api (relative)
// If loaded from localhost:3000 (React dev server), use /api (proxy handles it)
// Otherwise, default to http://localhost:5000/api
function getDefaultServerUrl() {
  if (typeof window === 'undefined') return '/api';
  
  const origin = window.location.origin;
  
  // If running from localhost:5000 (Electron production), use relative /api
  if (origin.includes('localhost:5000') || origin.includes('127.0.0.1:5000')) {
    return '/api';
  }
  
  // If running from localhost:3000 (React dev server), use /api (proxy)
  if (origin.includes('localhost:3000') || origin.includes('127.0.0.1:3000')) {
    return '/api';
  }
  
  // Default fallback
  return 'http://localhost:5000/api';
}

const DEFAULT_SERVER_URL = getDefaultServerUrl();

// Get server URL from localStorage or use default
export const getServerUrl = () => {
  const stored = localStorage.getItem('hisaabkitab_server_url');
  if (stored) {
    return stored.endsWith('/api') ? stored : `${stored}/api`;
  }
  return DEFAULT_SERVER_URL;
};

// Set server URL for LAN connection
export const setServerUrl = (url) => {
  if (url && url.trim()) {
    const cleanUrl = url.trim().replace(/\/$/, '').replace(/\/api$/, '');
    localStorage.setItem('hisaabkitab_server_url', `${cleanUrl}/api`);
  } else {
    localStorage.removeItem('hisaabkitab_server_url');
  }
};

// Check if running in client mode (connected to remote server)
export const isClientMode = () => {
  const serverUrl = getServerUrl();
  return serverUrl !== DEFAULT_SERVER_URL;
};

// Test connection to server
export const testConnection = async (serverUrl = null) => {
  const url = serverUrl || getServerUrl();
  // Handle both /api and full URLs
  let healthUrl;
  
  if (url.includes('http://') || url.includes('https://')) {
    // Full URL provided
    healthUrl = url.endsWith('/api') ? `${url.replace('/api', '')}/api/health` : `${url}/health`;
  } else {
    // Relative URL - use proxy in dev mode
    healthUrl = '/api/health';
  }
  
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000);
    
    const response = await fetch(healthUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      signal: controller.signal,
      mode: 'cors',
      credentials: 'omit'
    });
    
    clearTimeout(timeoutId);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    return {
      connected: true,
      mode: data.mode || 'full-access',
      message: data.message || 'Connected'
    };
  } catch (error) {
    // Don't log connection errors in console to avoid noise
    // Only return failure status
    return {
      connected: false,
      mode: 'offline',
      message: error.name === 'AbortError' ? 'Connection timeout' : 'Connection failed'
    };
  }
};

// Get local IP addresses (helper for finding server IP)
export const getLocalIPs = async () => {
  // This is a placeholder - in a real implementation, you might use
  // Electron's network API or a library like 'network-interfaces'
  return [];
};

